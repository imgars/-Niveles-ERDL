<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editor de Rankcard - Niveles</title>
  <link rel="stylesheet" href="/css/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    .rankcard-editor { max-width: 900px; margin: 0 auto; padding: 20px; }
    .rankcard-editor h1 { text-align: center; color: var(--primary, #FFD700); margin-bottom: 20px; font-size: 14px; }
    .editor-layout { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }
    @media (max-width: 768px) { .editor-layout { grid-template-columns: 1fr; } }
    .preview-panel { background: rgba(0,0,0,0.4); border: 2px solid var(--accent, #5865F2); padding: 16px; border-radius: 8px; }
    .preview-panel img { width: 100%; max-width: 800px; height: auto; display: block; margin: 0 auto; image-rendering: pixelated; }
    .preview-placeholder { min-height: 250px; display: flex; align-items: center; justify-content: center; color: #888; border: 2px dashed #444; }
    .controls-panel { background: rgba(0,0,0,0.4); border: 2px solid var(--accent); padding: 16px; border-radius: 8px; height: fit-content; }
    .control-group { margin-bottom: 16px; }
    .control-group label { display: block; font-size: 10px; color: var(--accent); margin-bottom: 6px; }
    .color-row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .color-swatch { width: 32px; height: 32px; border: 2px solid #fff; cursor: pointer; border-radius: 4px; }
    .color-input { width: 100px; padding: 6px; background: #2a2d31; border: 1px solid #444; color: #fff; font-size: 11px; }
    .cost-display { background: rgba(255,215,0,0.2); border: 2px solid #FFD700; padding: 12px; margin: 16px 0; text-align: center; }
    .cost-display .total { font-size: 18px; color: #FFD700; font-weight: bold; }
    .cost-display .balance { font-size: 11px; color: #888; margin-top: 4px; }
    .btn-purchase { width: 100%; padding: 12px; background: #00AA00; color: #fff; border: 2px solid #00FF00; font-weight: bold; cursor: pointer; font-size: 12px; }
    .btn-purchase:hover { background: #00CC00; }
    .btn-purchase:disabled { background: #444; border-color: #666; cursor: not-allowed; }
    .btn-preview { padding: 8px 16px; background: #5865F2; color: #fff; border: none; cursor: pointer; margin-top: 8px; font-size: 11px; }
    .error-msg { color: #ff4444; font-size: 11px; margin: 8px 0; }
    .vip-badge { background: linear-gradient(90deg,#FF00FF,#00FFFF); color: #000; padding: 2px 8px; font-size: 9px; font-weight: bold; }
    .draw-section { margin-bottom: 20px; }
    .draw-canvas-wrap { overflow: auto; max-width: 100%; border: 2px solid var(--accent); background: #1a1a1a; }
    #draw-canvas { display: block; cursor: crosshair; max-width: 100%; height: auto; }
    .brush-row { display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0; align-items: center; }
    .brush-btn { padding: 6px 10px; font-size: 10px; background: #2a2d31; border: 1px solid #444; color: #fff; cursor: pointer; border-radius: 4px; }
    .brush-btn.active { border-color: var(--accent); background: #36393F; }
    .brush-btn.vip { border-color: #FF00FF; }
    .logo-pos-grid { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 4px; align-items: center; font-size: 10px; margin-top: 4px; }
    .logo-pos-grid input[type="number"] { width: 56px; padding: 4px; background: #2a2d31; border: 1px solid #444; color: #fff; }
  </style>
</head>
<body>
  <div class="scanlines"></div>
  <div class="pixel-bg"></div>

  <div class="rankcard-editor">
    <h1>üé® EDITOR DE RANKCARD PERSONALIZADA</h1>

    <div id="loading" style="text-align:center;padding:40px;">
      <p>Verificando token...</p>
    </div>

    <div id="error-screen" style="display:none;text-align:center;padding:40px;color:#ff4444;">
      <h2>Token inv√°lido o expirado</h2>
      <p>Pide a un <strong>staff</strong> que use <code>/rankcard link</code> en Discord para obtener un enlace (v√°lido 15 min)</p>
    </div>

    <div id="editor-screen" style="display:none;">
      <div class="editor-layout">
        <div>
          <div class="draw-section preview-panel">
            <h3 style="font-size:11px;color:var(--accent);margin-bottom:8px;">‚úèÔ∏è Dibujar en la tarjeta</h3>
            <div class="control-group">
              <label>Color del pincel</label>
              <div class="brush-row" id="draw-colors"></div>
            </div>
            <div class="control-group">
              <label>Pincel</label>
              <div class="brush-row" id="draw-brushes"></div>
            </div>
            <div class="control-group">
              <label>Tama√±o: <span id="brush-size-val">8</span>px</label>
              <input type="range" id="brush-size" min="2" max="30" value="8" style="width:100%;">
            </div>
            <div class="brush-row">
              <button type="button" class="btn-preview" id="draw-clear">Borrar dibujo</button>
            </div>
            <div class="draw-canvas-wrap">
              <canvas id="draw-canvas" width="800" height="250"></canvas>
            </div>
          </div>
          <div class="preview-panel" style="margin-top:16px;">
          <h3 style="font-size:11px;color:var(--accent);margin-bottom:12px;">Previsualizaci√≥n</h3>
          <div id="preview-container">
            <div class="preview-placeholder" id="preview-placeholder">Haz clic en "Actualizar Vista Previa"</div>
            <img id="preview-img" src="" alt="Preview" style="display:none;">
          </div>
          <button type="button" class="btn-preview" id="btn-preview">Actualizar Vista Previa</button>
          </div>
        </div>

        <div class="controls-panel">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <img id="user-avatar" src="" alt="" style="width:48px;height:48px;border-radius:50%;">
            <div>
              <strong id="user-name"></strong>
              <span id="vip-badge" class="vip-badge" style="display:none;">VIP/BOOSTER</span>
              <div class="cost-display">
                <div>üí∞ <span id="user-lagcoins">0</span> Lagcoins</div>
              </div>
            </div>
          </div>

          <div class="control-group">
            <label>Color de fondo</label>
            <div class="color-row">
              <input type="color" id="color-bg" value="#36393F" class="color-swatch">
              <input type="text" id="color-bg-hex" value="#36393F" class="color-input" maxlength="7">
            </div>
          </div>

          <div class="control-group">
            <label>Color de acento</label>
            <div class="color-row">
              <input type="color" id="color-accent" value="#5865F2" class="color-swatch">
              <input type="text" id="color-accent-hex" value="#5865F2" class="color-input" maxlength="7">
            </div>
            <div id="neon-palette" style="display:none;margin-top:8px;">
              <label style="font-size:9px;">Paleta Ne√≥n (VIP/Booster):</label>
              <div class="color-row" id="neon-colors"></div>
            </div>
          </div>

          <div class="control-group">
            <label>Color de texto</label>
            <div class="color-row">
              <input type="color" id="color-text" value="#FFFFFF" class="color-swatch">
              <input type="text" id="color-text-hex" value="#FFFFFF" class="color-input" maxlength="7">
            </div>
          </div>

          <div class="control-group">
            <label>Color de barra XP</label>
            <div class="color-row">
              <input type="color" id="color-bar" value="#5865F2" class="color-swatch">
              <input type="text" id="color-bar-hex" value="#5865F2" class="color-input" maxlength="7">
            </div>
          </div>

          <div class="control-group" id="neon-toggle-wrap" style="display:none;">
            <label><input type="checkbox" id="use-neon"> Usar efecto Ne√≥n</label>
          </div>

          <div class="control-group">
            <label>Tipograf√≠a</label>
            <select id="font-select" style="width:100%;padding:8px;background:#2a2d31;border:1px solid #444;color:#fff;font-size:11px;"></select>
          </div>

          <div class="control-group" id="logos-section">
            <label>Logos e im√°genes (Discord CDN) - Max <span id="max-logos">1</span> ‚Äî Arrastra o indica X, Y, Ancho, Alto</label>
            <div id="logo-inputs"></div>
          </div>

          <div class="cost-display">
            <div class="total">Total: <span id="cost-total">7500</span> Lagcoins</div>
            <div class="balance" id="cost-breakdown">Base: 7500</div>
          </div>

          <p id="purchase-error" class="error-msg" style="display:none;"></p>
          <button type="button" class="btn-purchase" id="btn-purchase">Confirmar y Pagar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let token = null;
    let userData = null;
    let drawCtx = null;
    let isDrawing = false;
    let lastX = 0, lastY = 0;
    let drawColor = '#FFFFFF';
    let brushId = 'round';
    let brushSize = 8;

    function getToken() {
      const params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    function syncColorInputs(id) {
      const colorEl = document.getElementById(`color-${id}`);
      const hexEl = document.getElementById(`color-${id}-hex`);
      if (!colorEl || !hexEl) return;
      colorEl.addEventListener('input', () => hexEl.value = colorEl.value);
      hexEl.addEventListener('input', (e) => {
        if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) colorEl.value = e.target.value;
      });
    }

    function getConfig() {
      const canvas = document.getElementById('draw-canvas');
      let drawLayer = null;
      if (canvas && drawCtx) {
        const d = canvas.toDataURL('image/png');
        if (d.length > 100) drawLayer = d;
      }
      return {
        backgroundColor: document.getElementById('color-bg').value,
        accentColor: document.getElementById('color-accent').value,
        textColor: document.getElementById('color-text').value,
        barColor: document.getElementById('color-bar').value,
        useNeonPalette: document.getElementById('use-neon')?.checked || false,
        fontId: document.getElementById('font-select').value,
        baseImages: [],
        logos: [],
        drawLayer: drawLayer
      };
    }

    function getLogosFromInputs() {
      const max = userData?.options?.maxImages || 1;
      const logos = [];
      for (let i = 0; i < max; i++) {
        const urlEl = document.getElementById(`logo-url-${i}`);
        if (!urlEl?.value?.trim()) continue;
        const x = Math.max(0, Math.min(800, parseInt(document.getElementById(`logo-x-${i}`)?.value, 10) || 650));
        const y = Math.max(0, Math.min(250, parseInt(document.getElementById(`logo-y-${i}`)?.value, 10) || 80));
        const w = Math.max(20, Math.min(150, parseInt(document.getElementById(`logo-w-${i}`)?.value, 10) || 60));
        const h = Math.max(20, Math.min(150, parseInt(document.getElementById(`logo-h-${i}`)?.value, 10) || 60));
        logos.push({ url: urlEl.value.trim(), x, y, width: w, height: h });
      }
      return logos;
    }

    function drawStroke(ctx, x1, y1, x2, y2) {
      ctx.strokeStyle = brushId === 'eraser' ? 'rgba(0,0,0,0)' : drawColor;
      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      if (brushId === 'eraser') {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.strokeStyle = 'rgba(0,0,0,0.5)';
      } else ctx.globalCompositeOperation = 'source-over';
      if (brushId === 'square') ctx.lineCap = 'butt';
      if (brushId === 'spray') {
        const steps = Math.max(4, Math.floor(Math.sqrt((x2-x1)**2 + (y2-y1)**2) / 2));
        for (let i = 0; i < steps; i++) {
          const t = i / steps;
          const x = x1 + (x2 - x1) * t + (Math.random() - 0.5) * brushSize;
          const y = y1 + (y2 - y1) * t + (Math.random() - 0.5) * brushSize;
          ctx.beginPath();
          ctx.arc(x, y, brushSize / 4, 0, Math.PI * 2);
          ctx.fillStyle = drawColor;
          ctx.fill();
        }
        return;
      }
      if (brushId === 'neon') {
        ctx.shadowBlur = 15;
        ctx.shadowColor = drawColor;
      }
      if (brushId === 'marker') ctx.globalAlpha = 0.5;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.stroke();
      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;
      ctx.globalCompositeOperation = 'source-over';
    }

    function initDrawCanvas() {
      const canvas = document.getElementById('draw-canvas');
      if (!canvas) return;
      drawCtx = canvas.getContext('2d');
      drawCtx.fillStyle = 'rgba(0,0,0,0)';
      drawCtx.fillRect(0, 0, 800, 250);

      function getXY(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = 800 / rect.width;
        const scaleY = 250 / rect.height;
        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top) * scaleY
        };
      }

      canvas.addEventListener('mousedown', (e) => {
        isDrawing = true;
        const { x, y } = getXY(e);
        lastX = x; lastY = y;
        if (brushId === 'round' || brushId === 'square') {
          drawCtx.fillStyle = brushId === 'eraser' ? 'rgba(0,0,0,0.5)' : drawColor;
          if (brushId === 'eraser') drawCtx.globalCompositeOperation = 'destination-out';
          const s = brushSize / 2;
          if (brushId === 'square') drawCtx.fillRect(x - s, y - s, brushSize, brushSize);
          else drawCtx.beginPath(); drawCtx.arc(x, y, s, 0, Math.PI * 2); drawCtx.fill();
          drawCtx.globalCompositeOperation = 'source-over';
        }
      });
      canvas.addEventListener('mousemove', (e) => {
        if (!isDrawing) return;
        const { x, y } = getXY(e);
        drawStroke(drawCtx, lastX, lastY, x, y);
        lastX = x; lastY = y;
      });
      canvas.addEventListener('mouseup', () => { isDrawing = false; });
      canvas.addEventListener('mouseleave', () => { isDrawing = false; });
    }

    function clearDrawCanvas() {
      if (!drawCtx) return;
      drawCtx.clearRect(0, 0, 800, 250);
    }

    async function loadUser() {
      token = getToken();
      if (!token) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-screen').style.display = 'block';
        return;
      }

      try {
        const res = await fetch(`/api/rankcard/verify?token=${encodeURIComponent(token)}`);
        if (!res.ok) {
          throw new Error('Token inv√°lido');
        }
        userData = await res.json();
        initEditor();
      } catch (e) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error-screen').style.display = 'block';
      }
    }

    function initEditor() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('editor-screen').style.display = 'block';

      document.getElementById('user-avatar').src = userData.avatar || '';
      document.getElementById('user-name').textContent = userData.username || 'Usuario';
      document.getElementById('user-lagcoins').textContent = (userData.lagcoins || 0).toLocaleString();

      if (userData.hasVIPBenefits) {
        document.getElementById('vip-badge').style.display = 'inline-block';
        document.getElementById('neon-palette').style.display = 'block';
        document.getElementById('neon-toggle-wrap').style.display = 'block';
        const neonDiv = document.getElementById('neon-colors');
        (userData.options?.neonColors || []).forEach(c => {
          const sw = document.createElement('div');
          sw.className = 'color-swatch';
          sw.style.backgroundColor = c;
          sw.style.cursor = 'pointer';
          sw.title = c;
          sw.addEventListener('click', () => {
            document.getElementById('color-accent').value = c;
            document.getElementById('color-accent-hex').value = c;
          });
          neonDiv.appendChild(sw);
        });
      }

      const fontSelect = document.getElementById('font-select');
      fontSelect.innerHTML = '';
      (userData.options?.standardFonts || []).forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name;
        fontSelect.appendChild(opt);
      });
      (userData.options?.premiumFonts || []).forEach(f => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name + ' (VIP)';
        fontSelect.appendChild(opt);
      });

      const drawColorsRow = document.getElementById('draw-colors');
      drawColorsRow.innerHTML = '';
      (userData.options?.drawColors || ['#FFFFFF','#000000','#FF0000','#00FF00','#0000FF']).forEach(c => {
        const sw = document.createElement('div');
        sw.className = 'color-swatch';
        sw.style.backgroundColor = c;
        sw.style.cursor = 'pointer';
        sw.title = c;
        sw.addEventListener('click', () => { drawColor = c; document.querySelectorAll('#draw-colors .color-swatch').forEach(s => s.style.border = '2px solid #444'); sw.style.border = '2px solid #FFD700'; });
        drawColorsRow.appendChild(sw);
      });
      if (drawColorsRow.firstChild) drawColorsRow.firstChild.style.border = '2px solid #FFD700';

      const brushesRow = document.getElementById('draw-brushes');
      brushesRow.innerHTML = '';
      (userData.options?.brushes || []).forEach(b => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'brush-btn' + (b.premium ? ' vip' : '');
        btn.textContent = b.name;
        btn.dataset.id = b.id;
        btn.addEventListener('click', () => { brushId = b.id; document.querySelectorAll('#draw-brushes .brush-btn').forEach(x => x.classList.remove('active')); btn.classList.add('active'); });
        brushesRow.appendChild(btn);
      });
      if (brushesRow.firstChild) brushesRow.firstChild.classList.add('active');

      document.getElementById('brush-size').addEventListener('input', (e) => { brushSize = parseInt(e.target.value, 10); document.getElementById('brush-size-val').textContent = brushSize; });
      document.getElementById('draw-clear').addEventListener('click', clearDrawCanvas);

      initDrawCanvas();

      const maxLogos = userData.options?.maxImages || 1;
      document.getElementById('max-logos').textContent = maxLogos;

      const logoContainer = document.getElementById('logo-inputs');
      logoContainer.innerHTML = '';
      for (let i = 0; i < maxLogos; i++) {
        const wrap = document.createElement('div');
        wrap.style.marginTop = '8px';
        wrap.innerHTML = `
          <input type="text" id="logo-url-${i}" placeholder="URL imagen ${i + 1} (Discord CDN)" class="color-input" style="width:100%;">
          <div class="logo-pos-grid">
            <span>Posici√≥n (0-800, 0-250):</span>
            <input type="number" id="logo-x-${i}" placeholder="X" min="0" max="800" value="${650 + i * 50}">
            <input type="number" id="logo-y-${i}" placeholder="Y" min="0" max="250" value="80">
            <input type="number" id="logo-w-${i}" placeholder="Ancho" min="20" max="150" value="60">
            <input type="number" id="logo-h-${i}" placeholder="Alto" min="20" max="150" value="60">
          </div>`;
        logoContainer.appendChild(wrap);
      }

      if (userData.rankcard_custom) {
        const c = userData.rankcard_custom;
        if (c.backgroundColor) { document.getElementById('color-bg').value = c.backgroundColor; document.getElementById('color-bg-hex').value = c.backgroundColor; }
        if (c.accentColor) { document.getElementById('color-accent').value = c.accentColor; document.getElementById('color-accent-hex').value = c.accentColor; }
        if (c.textColor) { document.getElementById('color-text').value = c.textColor; document.getElementById('color-text-hex').value = c.textColor; }
        if (c.barColor) { document.getElementById('color-bar').value = c.barColor; document.getElementById('color-bar-hex').value = c.barColor; }
        if (c.fontId) document.getElementById('font-select').value = c.fontId;
        if (c.useNeonPalette) document.getElementById('use-neon').checked = true;
        if (c.logos?.length) {
          c.logos.forEach((logo, i) => {
            const urlEl = document.getElementById(`logo-url-${i}`);
            if (urlEl) urlEl.value = logo.url || '';
            const xEl = document.getElementById(`logo-x-${i}`);
            if (xEl) xEl.value = logo.x ?? (650 + i * 50);
            const yEl = document.getElementById(`logo-y-${i}`);
            if (yEl) yEl.value = logo.y ?? 80;
            const wEl = document.getElementById(`logo-w-${i}`);
            if (wEl) wEl.value = logo.width ?? 60;
            const hEl = document.getElementById(`logo-h-${i}`);
            if (hEl) hEl.value = logo.height ?? 60;
          });
        }
        if (c.drawLayer && c.drawLayer.startsWith('data:image/png;base64,')) {
          const img = new Image();
          img.onload = () => {
            if (drawCtx) { drawCtx.drawImage(img, 0, 0, 800, 250); }
          };
          img.src = c.drawLayer;
        }
      }

      ['bg', 'accent', 'text', 'bar'].forEach(syncColorInputs);

      document.getElementById('btn-preview').addEventListener('click', updatePreview);
      document.getElementById('btn-purchase').addEventListener('click', doPurchase);

      updateCost();
      document.querySelectorAll('#color-bg, #color-accent, #color-text, #color-bar, #font-select, #use-neon').forEach(el => {
        el.addEventListener('change', updateCost);
      });
      document.getElementById('logos-section').addEventListener('input', updateCost);
    }

    async function updateCost() {
      const config = { ...getConfig(), logos: getLogosFromInputs() };
      try {
        const res = await fetch('/api/rankcard/calculate-cost', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, config })
        });
        const data = await res.json();
        if (data.total !== undefined) {
          document.getElementById('cost-total').textContent = data.total.toLocaleString();
          document.getElementById('cost-breakdown').textContent = `Base: 7500${data.breakdown?.extras > 0 ? ' + ' + data.breakdown.extras + ' extras' : ''}`;
        }
      } catch (e) {
        console.error(e);
      }
    }

    async function updatePreview() {
      const config = { ...getConfig(), logos: getLogosFromInputs() };
      try {
        const res = await fetch('/api/rankcard/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, config })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        document.getElementById('preview-placeholder').style.display = 'none';
        const img = document.getElementById('preview-img');
        img.src = url;
        img.style.display = 'block';
      } catch (e) {
        document.getElementById('preview-placeholder').textContent = 'Error al generar vista previa';
        document.getElementById('preview-placeholder').style.display = 'flex';
        document.getElementById('preview-img').style.display = 'none';
      }
    }

    async function doPurchase() {
      const config = { ...getConfig(), logos: getLogosFromInputs() };
      const errEl = document.getElementById('purchase-error');
      errEl.style.display = 'none';

      try {
        const res = await fetch('/api/rankcard/purchase', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, config })
        });
        const data = await res.json();

        if (!res.ok) {
          errEl.textContent = data.error || 'Error al procesar';
          if (data.balance !== undefined) errEl.textContent += ` (Tienes: ${data.balance} LC)`;
          errEl.style.display = 'block';
          return;
        }

        alert('¬°Rankcard guardada! Usa /level en Discord para verla.');
        document.getElementById('user-lagcoins').textContent = (data.newBalance || 0).toLocaleString();
        userData.lagcoins = data.newBalance;
      } catch (e) {
        errEl.textContent = 'Error de conexi√≥n';
        errEl.style.display = 'block';
      }
    }

    document.addEventListener('DOMContentLoaded', loadUser);
  </script>
</body>
</html>
